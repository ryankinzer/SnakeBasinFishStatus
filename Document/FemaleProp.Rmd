---
title: "Female Proportions - Steelhead"
author: "Kevin See"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
    html_notebook:
editor_options: 
  chunk_output_type: inline
---

```{r setUp_options, echo = F, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

# Introduction

This work is to estimate female proportions within each TRT population covered by DABOM, so we can combine that with escapement estimates and get an estimate of female escapement to each branch and population. We started with cleaned observations from PITcleanr, which Rick Orme then finalized.

```{r}
# load needed libraries
library(tidyverse)
library(readxl)
library(jagsUI)
```

# Hierarchical Model

Because some branches have many more fish returning to them than others, we wanted to develop a hierarchical model that would allow for some borrowing of information from larger branches to smaller branches, to avoid skewing the sex ratio due solely to small sample sizes in some branches. We are ultimately trying to estimate the proportion of females at the TRT population scale, so we focused our model to be able to do that. Our model looks like:

\begin{aligned}

f_i &\sim Bin(p_{pop_i}, N_i) \\
\text{logit}(p_{pop}) &\sim N(\mu, \sigma^2) \\

\end{aligned}

where $f_i$ is the number of females observed in a branch, $N_i$ is the total number of sexed tags observed in that branch, and $p_{pop_i}$ is the proportion of females for the population containing model branch $i$ (the quantity of interest). We imposed some hierarchy by assuming that the logit of $p_{pop}$ comes from a normal distribution centered around a value, $\mu$, that represents the overall female proportion for the entire DPS. The variation between populations is captured by $\sigma^2$. 

We write this model in the JAGS language.

```{r}
modelNm = '../ModelFiles/FemalePropJAGS.txt'

modelCode = '
model {
  
  for(i in 1:length(f)) {
    f[i] ~ dbin(p[popNum[i]], tags[i])
  }

  for(j in 1:max(popNum)) {
    p[j] <- ilogit(logit_p[j])
    logit_p[j] ~ dnorm(mu, tau)
  }
  # transform overall mean back to proportion scale
  mu_ilogit <- ilogit(mu)

  mu ~ dnorm(0, 0.001)
  sig ~ dunif(0, 100)
  tau <- pow(sig, -2)

}'

cat(modelCode,
    file = modelNm)
```

# Prepare Data

We read the data in from PITcleanr summaries that have been generated previously.

```{r}
# set species
spp = 'Steelhead'
# set year
yr = 2014

# where are the tag summaries stored?
tagSummDir = '../output/tagSummaries/'

# read in data
modSexDf = read_excel(paste0(tagSummDir, 'LGR_', spp, '_', yr, '.xlsx'),
                      'SexRatio',
                      progress = F)

# pull out relevant bits for JAGS, and name them appropriately
jagsData = modSexDf %>%
  filter(!is.na(modBranch)) %>%
  mutate(popNum = as.integer(as.factor(TRT))) %>%
  select(f = F,
         tags = nSexed,
         popNum) %>%
  as.list()

```

Then we set which parameters to save with JAGS, and run the model.

```{r}
# set parameters to save
jagsParams = c('p', 'mu', 'sig', 'mu_ilogit')

# run JAGS model
mod = jags(data = jagsData,
           parameters.to.save = jagsParams,
           model.file = modelNm,
           n.chains = 3,
           n.iter = 10000,
           n.burnin = 5000,
           n.thin = 20,
           verbose = F)

# mod2 = glmer(cbind(F, M) ~ 1 + (1 | TRT),
#              data = modSexDf,
#              family = binomial)

```

# Model Output

We can take a quick look at a summary of the model:

```{r}
summary(mod)
```

If that looks OK, we can make a plot showcasing the output. The one below shows the estimates of female proporations for each TRT population, color coded by MPG, as well as the overall average proportion for the Snake River DPS. The point shows the posterior mean, the thick lines show the 50% credible intervals, and the thinner lines show the 95% credible intervals. 

```{r}
# female proportion by model branch, colored by MPG
mod$summary %>%
  as_tibble(rownames = 'param') %>%
  filter(grepl('^p', param)) %>%
  mutate(popNum = str_extract(param, '[[:digit:]]+'),
         popNum = as.integer(popNum)) %>%
  left_join(modSexDf %>%
              filter(!is.na(TRT)) %>%
              mutate(popNum = jagsData$popNum),
            by = 'popNum') %>%
  bind_rows(mod$summary %>%
              as_tibble(rownames = 'param') %>%
              filter(param == 'mu_ilogit')) %>%
  mutate_at(vars(MPG, TRT, modBranch),
            list(fct_explicit_na),
            na_level = 'Overall') %>%
  mutate(TRT = fct_reorder(TRT, mean),
         TRT = fct_relevel(TRT, 'Overall',
                           after = 0)) %>%
  ggplot(aes(x = TRT,
             y = mean,
             color = MPG)) +
  geom_linerange(aes(ymin = `2.5%`,
                     ymax = `97.5%`)) +
  geom_linerange(aes(ymin = `25%`,
                     ymax = `75%`),
                 size = 2) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0.5,
             linetype = 2) +
  scale_color_brewer(palette = 'Set3') +
  theme_bw() +
  coord_flip() +
  theme(legend.position = 'bottom') +
  labs(y = 'Female Proportion',
       x = 'TRT Population',
       title = paste(spp, yr))
```
